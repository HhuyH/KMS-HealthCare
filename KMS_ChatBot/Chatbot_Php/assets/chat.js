function appendMessage(message) {
    const div = document.createElement("div");
    div.textContent = message;
    document.getElementById("chat-box").appendChild(div);
    scrollToBottom();
}

function scrollToBottom() {
    const chatBox = document.getElementById("chat-box");
    chatBox.scrollTop = chatBox.scrollHeight;
}

// G·ªçi API chat kh√¥ng stream, tr·∫£ v·ªÅ reply ƒë·∫ßy ƒë·ªß 1 l·∫ßn
async function sendChatMessage(message, history) {
    const response = await fetch("http://127.0.0.1:8000/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message, history }),
    });
    if (!response.ok) throw new Error("L·ªói khi k·∫øt n·ªëi server");
    const data = await response.json();
    return data.reply;
}

// G·ªçi API chat stream tr·∫£ v·ªÅ t·ª´ng ph·∫ßn nh·ªè, g·ªçi callback onUpdate m·ªói l·∫ßn nh·∫≠n text m·ªõi
async function sendChatStream(message, history, onUpdate) {
    const response = await fetch("http://127.0.0.1:8000/chat/stream", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Accept": "text/event-stream",
        },
        body: JSON.stringify({ message, history }),
    });

    if (!response.ok) throw new Error("L·ªói khi k·∫øt n·ªëi server");

    const reader = response.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = "";

    while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const parts = buffer.split("\n\n");

        for (let i = 0; i < parts.length - 1; i++) {
            const part = parts[i].trim();
            if (part.startsWith("data:")) {
                const jsonStr = part.replace(/^data:\s*/, "");
                if (jsonStr === "[DONE]") return;
                try {
                    const dataObj = JSON.parse(jsonStr);
                    onUpdate(dataObj.text);
                } catch (err) {
                    console.error("L·ªói parse JSON:", err);
                    onUpdate("[L·ªói d·ªØ li·ªáu]");
                }
            }
        }
        buffer = parts[parts.length - 1];
    }
}


document.getElementById("chat-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const input = document.getElementById("userInput");
    const message = input.value.trim();
    if (!message) return;

    appendMessage("üë§ B·∫°n: " + message);
    input.value = "";
    input.disabled = true;

    // L·∫•y history t·ª´ PHP session
    const history = await fetch("get_history.php", {
    credentials: "include"
    }).then(res => res.json());


    // C·∫≠p nh·∫≠t history user
    await fetch("update_history.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ role: "user", content: message }),
        credentials: "include"
    });

    // Bi·∫øn ch·ªçn d√πng streaming hay kh√¥ng
    const useStreaming = true; // true ƒë·ªÉ d√πng stream, false ƒë·ªÉ g·ªçi API b√¨nh th∆∞·ªùng

    if (!useStreaming) {
        // G·ªçi API b√¨nh th∆∞·ªùng (kh√¥ng stream)
        try {
            const reply = await sendChatMessage(message, history);
            appendMessage("ü§ñ Bot: " + reply);
            // C·∫≠p nh·∫≠t history assistant
            await fetch("update_history.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ role: "assistant", content: reply }),
                credentials: "include"
            });
        } catch (err) {
            appendMessage("[L·ªói k·∫øt n·ªëi server]");
            console.error(err);
        } finally {
            input.disabled = false;
            input.focus();
        }
    } else {
        // G·ªçi API stream
        const botMessageDiv = document.createElement("div");
        botMessageDiv.textContent = "ü§ñ Bot: ";
        document.getElementById("chat-box").appendChild(botMessageDiv);

        let fullBotReply = "";
        try {
            await sendChatStream(message, history, (text) => {
                botMessageDiv.textContent += text;
                fullBotReply += text;
                scrollToBottom();
            });

            // C·∫≠p nh·∫≠t history assistant
            await fetch("update_history.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ role: "assistant", content: fullBotReply }),
                credentials: "include"
            });
        } catch (err) {
            botMessageDiv.textContent += "\n[Error x·∫£y ra khi nh·∫≠n d·ªØ li·ªáu]";
            console.error(err);
        } finally {
            input.disabled = false;
            input.focus();
        }
    }
});
